<html>
<head>
<script src="midi-parser-js-4.0.4/src/main.js"></script>
<script>
const TEMPO_FIELD = 81
var timer = undefined;
var midi = undefined;
var bpm = [];
var tempo_change_times = [];
var pixelsPerSecond = 100.; // Scrolling speed
var startTime = 0;
var running = false;

/**
 * Loads the MIDI file and plots the events as DIVs.
 */
window.onload = function(){
  var source = document.getElementById('filereader');
  MidiParser.parse( source, function(obj){
    midi = obj;
    // Find tempo information in track 0 (meta-info track)
    let meta_time = 0;
    for (event of midi.track[0].event) {
      meta_time += event.deltaTime;
      if (event.metaType == TEMPO_FIELD) {
        // Tempo is given as duration of one note in microseconds
        bpm.push(60 * 1000000 / event.data);
        tempo_change_times.push(meta_time);
      }
    }
    plot_events(midi.track);
  });
};

/**
 * (re-)Start the game.
 */
function start_game() {
  music = document.getElementById("music")
  music.currentTime = 0;
  running = true;
  startTime = new Date().getTime();
  requestAnimationFrame(scroll_events);
  music.play();
}

/**
 * Stop the game.
 */
function stop_game() {
  running = false;
  document.getElementById("music").pause();
  music.currentTime = 0;
  let output = document.getElementById("output");
  output.style.top = 0;
}

function get_pixelMultiplyer(time) {
  let i = 0;
  while (i < (tempo_change_times.length-1) && tempo_change_times[i+1] <= time) {
    i++;
  }
  let beatsPerSecond = bpm[i] / 60;
  //console.log(tempo_change_times, time, bpm[i]);
  return pixelsPerSecond / (midi.timeDivision * beatsPerSecond);
}

function timedelta_to_pixel_offset(t0, t_delta) {
  let t1 = t0 + t_delta;

  let i = 0;
  while (i < (tempo_change_times.length-1) && tempo_change_times[i+1] < t0) {
    i++;
  }
  let j = i;
  while (j < (tempo_change_times.length-1) && tempo_change_times[j+1] < t1) {
    j++;
  }
  //let bps_t0 = bpm[i] / 60;
  //let bps_t1 = bpm[j] / 60;
  let t_i = t0;
  let pixels = 0;
  for(k=i; k<j; k++) {
    console.log(k+1, t_i, tempo_change_times[k+1] - t_i);
    pixels += (tempo_change_times[k+1] - t_i) * pixelsPerSecond / (midi.timeDivision * (bpm[k+1] / 60));
    t_i = tempo_change_times[k+1];
    console.log(pixels, t_i);
  }
  pixels += (t1 - t_i) * pixelsPerSecond / (midi.timeDivision * (bpm[k] / 60));

  console.log(t0, t_delta, i, j, pixels);
  return pixels;
}

/**
 * Create DIVs for all MIDI events in all tracks.
 */
function plot_events(tracks) {
  let output = document.getElementById("output");

  // Skip the first MIDI tracks, which holds metadata.
  for (track_number=1; track_number<tracks.length; track_number++) {
    var events = tracks[track_number].event;
    var time = 0;
    let top = 0 ;

    // Events are organized in pairs: a note-on and a note-off event.
    for (i=0; i<events.length-1; i+=2) {
      //top += events[i].deltaTime * get_pixelMultiplyer(time);
      top += timedelta_to_pixel_offset(time, events[i].deltaTime);
      time += events[i].deltaTime;
      let box = document.createElement("div");
      //console.log(top);
      box.style.top = top;
      //box.style.height = events[i + 1].deltaTime * pixelMultiplyer;
      box.className = "track" + track_number;
      output.appendChild(box);
      //top += events[i + 1].deltaTime * get_pixelMultiplyer(time);
      top += timedelta_to_pixel_offset(time, events[i + 1].deltaTime);
      time += events[i + 1].deltaTime;
    }
  }

  // Add the beat bars
  total_beats = (time / midi.timeDivision) * bpm[0] / 60;
  let beat_time = 0;
  let top = 0;
  for (beat=0; beat<total_beats; beat++) {
    let box = document.createElement("div");
    box.className = "beat";
    //let pixelMultiplyer = get_pixelMultiplyer(beat_time);
    box.style.top = top;
    output.appendChild(box);
    //top += 4 * midi.timeDivision * pixelMultiplyer;
    top += timedelta_to_pixel_offset(beat_time, 4 * midi.timeDivision);
    beat_time += 4 * midi.timeDivision;
  }
}

/**
 * Scroll all the MIDI event DIVs.
 */
function scroll_events() {
  let output = document.getElementById("output");
  let now = new Date().getTime();
  let secondsElapsed = (now - startTime) / 1000;
  /*
  for (element of output.childNodes) {
    element.style.top = element.initialPosition - pixelsPerSecond * secondsElapsed;
  }
  */
  output.style.top = -pixelsPerSecond * secondsElapsed;
  if (running) {
    requestAnimationFrame(scroll_events);
  }
}
</script>

<style>
  body {
    background-color: black;
  }
  .track1 {
    position: absolute;
    margin-top: 225px;
    background-color: blue;
    width: 100px;
    left: 100px;
    height: 15px;
  }
  .track2 {
    position: absolute;
    margin-top: 225px;
    background-color: red;
    width: 100px;
    left: 250px;
    height: 15px;
  }
  .beat {
    position: absolute;
    width: 100%;
    border-top: 1px solid #aaa;
    margin-top: 225px;
  }
  #hitpoint {
    position:relative;
    top: 42px;
    z-index: 10000;
  }
  #output {
    position: absolute;
    top: 0px;
    width: 100%;
  }
</style>

</head>
<body width="100%">
  <audio src="mm.mp3" type="audio/mpeg" id="music" preload="auto"></audio>
  <div style="position:absolute; width:200px; right:10px">
    <input type="file" id="filereader"/>
    <button onclick="start_game()">START</button>
    <button onclick="stop_game()">STOP</button>
  </div>
  <hr id="hitpoint"/>
  <div id="output"></div>
<body>
</html>
