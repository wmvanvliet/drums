<html>
<head>
<script src="midi-parser-js-4.0.4/src/main.js"></script>
<script>
const NOTE_ON = 9;
const TEMPO_FIELD = 81;
const BAR = 999;
var timer = undefined;
var midi = undefined;
var pixelsPerSecond = 100.; // Scrolling speed
var startTime = 0;
var running = false;

/**
 * Loads the MIDI file and plots the events as DIVs.
 */
window.onload = function(){
  var source = document.getElementById('filereader');
  MidiParser.parse( source, function(obj){
    midi = obj;
    add_timing_info(midi);

    // Loop through all the events and draw things
    while (true) {
      let e = next_event(midi);
      if(e == undefined) {
        break; // No more events, we're done!
      } else {
        handle_event(e); // Does the drawing
      }
    }
  });
}

/**
 * Loops through all the events in all the tracks and converts the deltaTime to
 * absolute time.
 */
function add_timing_info(midi) {
  for (t of midi.track) {
    let time = 0;
    for (e of t.event) {
      time += e.deltaTime;
      e.time = time;
    }
  }
}

/**
 * Finds and returns the next MIDI event, irregardless of the track it is on.
 * Also returns bar events every 4 beats. Returns undefined when all events
 * have been returned.
 */
var next_bar_time = 0;
function next_event(midi) {
  // Find the track with the closest event
  next_track = undefined;
  for (t of midi.track) {
    if (t.event.length == 0) {
      continue;
    }
    if (next_track == undefined || t.event[0].time < next_track.event[0].time) {
      next_track = t;
    }
  }

  if (next_track == undefined) {
    // No more events
    return undefined;
  }

  // Perhaps we need a bar event first?
  console.log("Next bar at", next_bar_time);
  if (next_bar_time < next_track.event[0].time) {
    e = {type: BAR, time: next_bar_time};
    next_bar_time += 4 * midi.timeDivision;
    return e;
  } else {
    return next_track.event.shift();
  }
}

/**
 * Examines a MIDI event and decides what to do with it.
 * Adds a box or bar, or updates the tempo.
 */
var time = 0; // Global clock
var bpm = 120; // Current tempo (beats per minute)
var pixel_offset = 0; // Current location to draw to (in pixels)
function handle_event(e) {
  // Advance the clock
  let deltaTime = e.time - time;
  pixel_offset += deltaTime * pixelsPerSecond / (midi.timeDivision * (bpm / 60));
  time = e.time;

  //console.log(time, pixel_offset, e);

  if (e.metaType == TEMPO_FIELD) {
    // Tempo is given as duration of one note in microseconds
    bpm = 60 * 1000000 / e.data;
    console.log("New tempo set", bpm);
  } else if (e.type == BAR) {
    console.log("Drawing bar at", e.time, pixel_offset);
    // Add a horizontal line to indicate a new bar
    let output = document.getElementById("output");
    let box = document.createElement("div");
    box.className = "beat";
    box.style.top = pixel_offset;
    output.appendChild(box);
  } else if (e.type == NOTE_ON) {
    console.log("Drawing note at", e.time, pixel_offset);
    // Add a box to indicate a note
    let output = document.getElementById("output");
    let box = document.createElement("div");
    box.style.top = pixel_offset;
    box.className = "track" + (e.channel + 1);
    output.appendChild(box);
  }
}

/**
 * (re-)Start the game.
 */
function start_game() {
  music = document.getElementById("music")
  music.currentTime = 0;
  running = true;
  startTime = new Date().getTime();
  requestAnimationFrame(scroll_events);
  music.play();
}

/**
 * Stop the game.
 */
function stop_game() {
  running = false;
  document.getElementById("music").pause();
  music.currentTime = 0;
  let output = document.getElementById("output");
  output.style.top = 0;
}

/**
 * Scroll all the MIDI event DIVs.
 */
function scroll_events() {
  let output = document.getElementById("output");
  let now = new Date().getTime();
  let secondsElapsed = (now - startTime) / 1000;
  output.style.top = -pixelsPerSecond * secondsElapsed;
  if (running) {
    requestAnimationFrame(scroll_events);
  }
}
</script>

<style>
  body {
    background-color: black;
  }
  .track1 {
    position: absolute;
    margin-top: 70px;
    background-color: blue;
    width: 100px;
    left: 100px;
    height: 15px;
  }
  .track2 {
    position: absolute;
    margin-top: 70px;
    background-color: red;
    width: 100px;
    left: 250px;
    height: 15px;
  }
  .beat {
    position: absolute;
    width: 100%;
    border-top: 1px solid #aaa;
    margin-top: 70px;
  }
  #hitpoint {
    position:relative;
    top: 42px;
    z-index: 10000;
  }
  #output {
    position: absolute;
    top: 0px;
    width: 100%;
  }
</style>

</head>
<body width="100%">
  <audio src="mm.mp3" type="audio/mpeg" id="music" preload="auto"></audio>
  <div style="position:absolute; width:200px; right:10px">
    <input type="file" id="filereader"/>
    <button onclick="start_game()">START</button>
    <button onclick="stop_game()">STOP</button>
  </div>
  <hr id="hitpoint"/>
  <div id="output"></div>
<body>
</html>
